public void testSubstituteVar() throws ServiceException {
    Services services = new Services();
    services.init();
    int depth = ConfigurationService.getInt(XConfiguration.CONFIGURATION_SUBSTITUTE_DEPTH);
    XConfiguration.initalized = false;
    XConfiguration conf = new XConfiguration();
    conf.set("key0", "hello");
    for (int i = 1; i < depth + 5; i++) {
        // key1, ${key0}
        conf.set(String.valueOf("key" + i), String.valueOf("${key" + (i - 1) + "}"));
    }
    assertEquals("hello", conf.get("key0"));
    assertEquals("hello", conf.get("key1"));
    assertEquals("hello", conf.get("key" + (depth - 1)));
    try {
        conf.get(String.valueOf("key" + (depth)));
        fail("Fail to apply substitution depth");
    } catch (IllegalStateException e) {
        assertTrue(e.getMessage().contains("Variable substitution depth too large: " + depth));
    }
    services.destroy();
}
