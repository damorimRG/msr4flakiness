public void testIsJobIdForThisServerBadZk() throws Exception {
    ZKJobsConcurrencyService zkjcs = new ZKJobsConcurrencyService();
    try {
        zkjcs.init(Services.get());
        assertTrue(zkjcs.isJobIdForThisServer("0000000-130521183438837-oozie-rkan-W"));
        assertTrue(zkjcs.isJobIdForThisServer("0000001-130521183438837-oozie-rkan-W"));
        assertTrue(zkjcs.isJobIdForThisServer("0000002-130521183438837-oozie-rkan-W"));
        assertTrue(zkjcs.isJobIdForThisServer("0000003-130521183438837-oozie-rkan-W"));
        assertTrue(zkjcs.isJobIdForThisServer("0000004-130521183438837-oozie-rkan-W"));
        assertTrue(zkjcs.isJobIdForThisServer("0000005-130521183438837-oozie-rkan-W"));
        assertTrue(zkjcs.isJobIdForThisServer("0000006-130521183438837-oozie-rkan-W"));
        assertTrue(zkjcs.isJobIdForThisServer("blah"));
        // simulating zookeeper problem
        zkjcs.zk.getClient().close();
        // Sleep to allow ZKUtils ServiceCache to update
        sleep(1000);
        try {
            zkjcs.isJobIdForThisServer("0000000-130521183438837-oozie-rkan-W");
            fail("Expected ServletException");
        } catch (ServiceException e) {
            assertEquals(ErrorCode.E1700, e.getErrorCode());
        }
    } finally {
        zkjcs.destroy();
    }
}
