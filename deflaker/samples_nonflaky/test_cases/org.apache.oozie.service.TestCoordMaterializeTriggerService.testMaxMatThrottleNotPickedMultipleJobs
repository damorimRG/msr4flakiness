public void testMaxMatThrottleNotPickedMultipleJobs() throws Exception {
    Services.get().destroy();
    setSystemProperty(CoordMaterializeTriggerService.CONF_MATERIALIZATION_SYSTEM_LIMIT, "3");
    services = new Services();
    services.init();
    jpaService = services.get(JPAService.class);
    Date start = new Date();
    Date end = new Date(start.getTime() + 3600 * 5 * 1000);
    CoordinatorJobBean job1 = addRecordToCoordJobTable(CoordinatorJob.Status.RUNNING, start, end, false, false, 1);
    addRecordToCoordActionTable(job1.getId(), 1, CoordinatorAction.Status.WAITING, "coord-action-get.xml", 0);
    addRecordToCoordActionTable(job1.getId(), 2, CoordinatorAction.Status.WAITING, "coord-action-get.xml", 0);
    job1.setMatThrottling(3);
    CoordJobQueryExecutor.getInstance().executeUpdate(CoordJobQuery.UPDATE_COORD_JOB, job1);
    CoordinatorJobBean job2 = addRecordToCoordJobTable(CoordinatorJob.Status.RUNNING, start, end, false, false, 1);
    addRecordToCoordActionTable(job2.getId(), 1, CoordinatorAction.Status.WAITING, "coord-action-get.xml", 0);
    addRecordToCoordActionTable(job2.getId(), 2, CoordinatorAction.Status.WAITING, "coord-action-get.xml", 0);
    job2.setMatThrottling(3);
    CoordJobQueryExecutor.getInstance().executeUpdate(CoordJobQuery.UPDATE_COORD_JOB, job2);
    CoordinatorJobBean job3 = addRecordToCoordJobTable(CoordinatorJob.Status.RUNNING, start, end, false, false, 1);
    addRecordToCoordActionTable(job3.getId(), 1, CoordinatorAction.Status.WAITING, "coord-action-get.xml", 0);
    addRecordToCoordActionTable(job3.getId(), 2, CoordinatorAction.Status.WAITING, "coord-action-get.xml", 0);
    job3.setMatThrottling(2);
    CoordJobQueryExecutor.getInstance().executeUpdate(CoordJobQuery.UPDATE_COORD_JOB, job3);
    job1 = jpaService.execute(new CoordJobGetJPAExecutor(job1.getId()));
    Date lastModifiedDate1 = job1.getLastModifiedTime();
    job2 = jpaService.execute(new CoordJobGetJPAExecutor(job2.getId()));
    Date lastModifiedDate2 = job2.getLastModifiedTime();
    job3 = jpaService.execute(new CoordJobGetJPAExecutor(job3.getId()));
    Date lastModifiedDate3 = job3.getLastModifiedTime();
    Runnable runnable = new CoordMaterializeTriggerRunnable(3600, 300);
    runnable.run();
    waitForModification(job1.getId(), lastModifiedDate1);
    waitForModification(job2.getId(), lastModifiedDate2);
    waitForModification(job3.getId(), lastModifiedDate3);
    job1 = jpaService.execute(new CoordJobGetJPAExecutor(job1.getId()));
    assertNotSame(lastModifiedDate1, job1.getLastModifiedTime());
    job2 = jpaService.execute(new CoordJobGetJPAExecutor(job2.getId()));
    assertNotSame(lastModifiedDate2, job2.getLastModifiedTime());
    job3 = jpaService.execute(new CoordJobGetJPAExecutor(job3.getId()));
    assertEquals(lastModifiedDate3, job3.getLastModifiedTime());
}
