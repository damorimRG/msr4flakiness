public void testLockReaper() throws Exception {
    ConfigurationService.set(ZKLocksService.REAPING_THRESHOLD, "1");
    ZKLocksService zkls = new ZKLocksService();
    try {
        zkls.init(Services.get());
        for (int i = 0; i < 10; ++i) {
            LockToken l = zkls.getReadLock(String.valueOf(i), 1);
            l.release();
        }
        waitFor(10000, new Predicate() {

            @Override
            public boolean evaluate() throws Exception {
                Stat stat = getClient().checkExists().forPath(ZKLocksService.LOCKS_NODE);
                return stat.getNumChildren() == 0;
            }
        });
        Stat stat = getClient().checkExists().forPath(ZKLocksService.LOCKS_NODE);
        assertEquals(0, stat.getNumChildren());
    } finally {
        zkls.destroy();
    }
}
