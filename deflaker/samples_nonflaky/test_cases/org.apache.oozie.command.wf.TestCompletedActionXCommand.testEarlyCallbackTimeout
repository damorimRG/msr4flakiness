public void testEarlyCallbackTimeout() throws Exception {
    final Instrumentation inst = Services.get().get(InstrumentationService.class).get();
    WorkflowJobBean job = addRecordToWfJobTable(WorkflowJob.Status.RUNNING, WorkflowInstance.Status.RUNNING);
    WorkflowActionBean action = addRecordToWfActionTable(job.getId(), "1", WorkflowAction.Status.PREP);
    final CompletedActionXCommand cmd = new CompletedActionXCommand(action.getId(), "SUCCEEDED", null);
    long xexceptionCount;
    try {
        xexceptionCount = inst.getCounters().get(XCommand.INSTRUMENTATION_GROUP).get(cmd.getName() + ".xexceptions").getValue();
    } catch (NullPointerException npe) {
        // counter might be null
        xexceptionCount = 0L;
    }
    assertEquals(0L, xexceptionCount);
    long executionsCount;
    try {
        executionsCount = inst.getCounters().get(XCommand.INSTRUMENTATION_GROUP).get(cmd.getName() + ".executions").getValue();
    } catch (NullPointerException npe) {
        // counter might be null
        executionsCount = 0L;
    }
    assertEquals(0L, executionsCount);
    long executionCount;
    try {
        executionCount = inst.getCounters().get(XCommand.INSTRUMENTATION_GROUP).get(cmd.getName() + ".execution").getValue();
    } catch (NullPointerException npe) {
        // counter might be null
        executionCount = 0L;
    }
    assertEquals(0L, executionCount);
    cmd.call();
    int timeout = 10000 * 5 * 2;
    waitFor(timeout, new Predicate() {

        @Override
        public boolean evaluate() throws Exception {
            long xexceptionCount;
            try {
                xexceptionCount = inst.getCounters().get(XCommand.INSTRUMENTATION_GROUP).get(cmd.getName() + ".xexceptions").getValue();
            } catch (NullPointerException npe) {
                // counter might be null
                xexceptionCount = 0L;
            }
            return (xexceptionCount == 1L);
        }
    });
    executionsCount = inst.getCounters().get(XCommand.INSTRUMENTATION_GROUP).get(cmd.getName() + ".executions").getValue();
    assertEquals(6L, executionsCount);
    try {
        executionCount = inst.getCounters().get(XCommand.INSTRUMENTATION_GROUP).get(cmd.getName() + ".execution").getValue();
    } catch (NullPointerException npe) {
        // counter might be null
        executionCount = 0L;
    }
    assertEquals(0L, executionCount);
    xexceptionCount = inst.getCounters().get(XCommand.INSTRUMENTATION_GROUP).get(cmd.getName() + ".xexceptions").getValue();
    assertEquals(1L, xexceptionCount);
}
