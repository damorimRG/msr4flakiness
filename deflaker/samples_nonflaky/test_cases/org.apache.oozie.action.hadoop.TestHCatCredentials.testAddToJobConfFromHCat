@Test
public void testAddToJobConfFromHCat() throws Exception {
    File hcatConfig = new File(OOZIE_HOME_DIR, "hcatConf.xml");
    Writer fw = new OutputStreamWriter(new FileOutputStream(hcatConfig), StandardCharsets.UTF_8);
    fw.write(getHiveConfig(TEST_HIVE_METASTORE_PRINCIPAL2, TEST_HIVE_METASTORE_URI2));
    fw.flush();
    fw.close();
    @SuppressWarnings("deprecation")
    Configuration conf = services.getConf();
    conf.set(HCatAccessorService.HCAT_CONFIGURATION, OOZIE_HOME_DIR + "/hcatConf.xml");
    services.init();
    HCatCredentialHelper hcatCredHelper = Mockito.mock(HCatCredentialHelper.class);
    PowerMockito.whenNew(HCatCredentialHelper.class).withNoArguments().thenReturn(hcatCredHelper);
    CredentialsProperties credProps = new CredentialsProperties("", "");
    credProps.setProperties(new HashMap<String, String>());
    HCatCredentials hcatCred = new HCatCredentials();
    final JobConf jobConf = new JobConf(false);
    Credentials credentials = new Credentials();
    PowerMockito.doAnswer(new Answer<Void>() {

        @Override
        public Void answer(InvocationOnMock invocation) throws Throwable {
            Object[] args = invocation.getArguments();
            Configuration jConf = (Configuration) args[1];
            jConf.set(HCAT_METASTORE_PRINCIPAL, (String) args[2]);
            jConf.set(HCAT_METASTORE_URI, (String) args[3]);
            return null;
        }
    }).when(hcatCredHelper).set(credentials, jobConf, TEST_HIVE_METASTORE_PRINCIPAL2, TEST_HIVE_METASTORE_URI2);
    hcatCred.updateCredentials(credentials, jobConf, credProps, null);
    assertEquals(TEST_HIVE_METASTORE_PRINCIPAL2, jobConf.get(HCAT_METASTORE_PRINCIPAL));
    assertEquals(TEST_HIVE_METASTORE_URI2, jobConf.get(HCAT_METASTORE_URI));
    assertNull(jobConf.get(HIVE_METASTORE_PRINCIPAL));
    assertNull(jobConf.get(HIVE_METASTORE_URI));
    hcatConfig.delete();
}
