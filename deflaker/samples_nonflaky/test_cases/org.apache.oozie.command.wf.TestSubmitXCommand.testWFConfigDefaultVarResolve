public void testWFConfigDefaultVarResolve() throws Exception {
    final OozieClient wfClient = LocalOozie.getClient();
    OutputStream os = new FileOutputStream(getTestCaseDir() + "/config-default.xml");
    XConfiguration defaultConf = new XConfiguration();
    defaultConf.set("outputDir", "default-output-dir");
    defaultConf.set("foo.bar", "default-foo-bar");
    defaultConf.set("foobarRef", "${foo.bar}");
    defaultConf.set("key", "default_value");
    defaultConf.set("should_resolve", "${should.resolve}");
    defaultConf.set("mixed", "${nameNode}/${outputDir}");
    defaultConf.writeXml(os);
    os.close();
    String workflowUri = getTestCaseFileUri("workflow.xml");
    String actionXml = "<map-reduce>" + "<job-tracker>${jobTracker}</job-tracker>" + "<name-node>${nameNode}</name-node>" + "        <prepare>" + "          <delete path=\"${nameNode}/user/${wf:user()}/mr/${outputDir}\"/>" + "        </prepare>" + "        <configuration>" + "          <property><name>bb</name><value>BB</value></property>" + "          <property><name>cc</name><value>from_action</value></property>" + "        </configuration>" + "      </map-reduce>";
    String wfXml = "<workflow-app xmlns=\"uri:oozie:workflow:0.5\" name=\"map-reduce-wf\">" + "    <start to=\"mr-node\"/>" + "    <action name=\"mr-node\">" + actionXml + "    <ok to=\"end\"/>" + "    <error to=\"fail\"/>" + "</action>" + "<kill name=\"fail\">" + "    <message>Map/Reduce failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>" + "</kill>" + "<end name=\"end\"/>" + "</workflow-app>";
    writeToFile(wfXml, workflowUri);
    Configuration conf = new XConfiguration();
    conf.set("nameNode", getNameNodeUri());
    conf.set("jobTracker", getJobTrackerUri());
    conf.set("foobarRef", "foobarRef");
    conf.set("key", "job_prop_value");
    conf.set(OozieClient.APP_PATH, workflowUri);
    conf.set(OozieClient.USER_NAME, getTestUser());
    conf.set("should.resolve", "resolved");
    SubmitXCommand sc = new SubmitXCommand(conf);
    final String jobId = sc.call();
    new StartXCommand(jobId).call();
    waitFor(15 * 1000, new Predicate() {

        public boolean evaluate() throws Exception {
            return wfClient.getJobInfo(jobId).getStatus() == WorkflowJob.Status.KILLED;
        }
    });
    String actionId = jobId + "@mr-node";
    WorkflowActionBean action = WorkflowActionQueryExecutor.getInstance().get(WorkflowActionQueryExecutor.WorkflowActionQuery.GET_ACTION, actionId);
    Element eAction = XmlUtils.parseXml(action.getConf());
    Element eConf = eAction.getChild("configuration", eAction.getNamespace());
    Configuration actionConf = new XConfiguration(new StringReader(XmlUtils.prettyPrint(eConf).toString()));
    assertEquals("default-output-dir", actionConf.get("outputDir"));
    assertEquals("BB", actionConf.get("bb"));
    assertEquals("from_action", actionConf.get("cc"));
    assertEquals("resolved", actionConf.get("should_resolve"));
    assertEquals("default-foo-bar", actionConf.get("foo.bar"));
    assertEquals("default-foo-bar", actionConf.get("foobarRef"));
    assertEquals("default_value", actionConf.get("key"));
    assertEquals(getNameNodeUri() + "/default-output-dir", actionConf.get("mixed"));
}
