@Test
public void testRetriesOnFailure() throws Exception {
    @SuppressWarnings("unchecked")
    Callable<String> operation = mock(Callable.class);
    final MutableInt callCount = new MutableInt(0);
    willAnswer(new Answer<Void>() {

        @Override
        public Void answer(InvocationOnMock invocation) throws Throwable {
            callCount.increment();
            throw new RuntimeException();
        }
    }).given(operation).call();
    boolean exceptionThrown = false;
    try {
        retryHandler.executeWithRetry(operation);
    } catch (RuntimeException e) {
        exceptionThrown = true;
    }
    assertTrue("Exception was not thrown", exceptionThrown);
    assertCallCount(3, callCount);
    assertNoRetryAttemptsAreInProgressOrExhausted();
}
