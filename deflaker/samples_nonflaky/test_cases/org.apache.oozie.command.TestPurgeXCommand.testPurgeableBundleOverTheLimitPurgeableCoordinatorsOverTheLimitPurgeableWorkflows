/**
 * Test : The workflow and coordinator should get purged, and the bundle parent should get purged --> all will get purged
 * There are more coordinator children than the limit
 *
 * @throws Exception if cannot insert records to the database
 */
public void testPurgeableBundleOverTheLimitPurgeableCoordinatorsOverTheLimitPurgeableWorkflows() throws Exception {
    BundleJobBean bundleJob = addRecordToBundleJobTable(Job.Status.SUCCEEDED, DateUtils.parseDateOozieTZ("2011-01-01T01:00Z"));
    CoordinatorJobBean[] coordJobs = new CoordinatorJobBean[TEST_CHILD_NUM];
    WorkflowJobBean[] wfJobs = new WorkflowJobBean[TEST_CHILD_NUM];
    WorkflowActionBean[] wfActions = new WorkflowActionBean[TEST_CHILD_NUM];
    CoordinatorActionBean[] coordActions = new CoordinatorActionBean[TEST_CHILD_NUM];
    BundleActionBean[] bundleActions = new BundleActionBean[TEST_CHILD_NUM];
    for (int i = 0; i < TEST_CHILD_NUM; ++i) {
        coordJobs[i] = addRecordToCoordJobTable(CoordinatorJob.Status.SUCCEEDED, false, false);
        coordJobs[i].setAppName("coord" + i);
        CoordJobQueryExecutor.getInstance().executeUpdate(CoordJobQuery.UPDATE_COORD_JOB, coordJobs[i]);
        wfJobs[i] = addRecordToWfJobTable(WorkflowJob.Status.SUCCEEDED, WorkflowInstance.Status.SUCCEEDED);
        wfActions[i] = addRecordToWfActionTable(wfJobs[i].getId(), "1", WorkflowAction.Status.OK);
        coordActions[i] = addRecordToCoordActionTable(coordJobs[i].getId(), 1, CoordinatorAction.Status.SUCCEEDED, "coord-action-get.xml", wfJobs[i].getId(), "SUCCEEDED", 0);
        bundleActions[i] = addRecordToBundleActionTable(bundleJob.getId(), coordJobs[i].getId(), coordJobs[i].getAppName(), 0, Job.Status.SUCCEEDED);
    }
    purgeWithDefaultParameters();
    assertBundleJobPurged(bundleJob);
    assertBundleActionsPurged(bundleActions);
    assertCoordinatorJobsPurged(coordJobs);
    assertCoordinatorActionsPurged(coordActions);
    assertWorkflowJobsPurged(wfJobs);
    assertWorkflowActionsPurged(wfActions);
}
