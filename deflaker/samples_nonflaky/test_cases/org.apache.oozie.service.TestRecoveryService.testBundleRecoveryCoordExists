/**
 * If the bundle action is in PREP state and coord is already created, recovery should not submit new coord
 * @throws Exception
 */
public void testBundleRecoveryCoordExists() throws Exception {
    final BundleJobBean bundle;
    final CoordinatorJob coord;
    bundle = addRecordToBundleJobTable(Job.Status.RUNNING, false);
    coord = addRecordToCoordJobTable(Job.Status.PREP, false, false);
    addRecordToBundleActionTable(bundle.getId(), coord.getId(), "coord1", 1, Job.Status.PREP);
    final JPAService jpaService = Services.get().get(JPAService.class);
    sleep(3000);
    Runnable recoveryRunnable = new RecoveryRunnable(0, 1, 1);
    recoveryRunnable.run();
    waitFor(3000, new Predicate() {

        public boolean evaluate() throws Exception {
            BundleActionBean mybundleAction = jpaService.execute(new BundleActionGetJPAExecutor(bundle.getId(), "coord1"));
            return !mybundleAction.getCoordId().equals(coord.getId());
        }
    });
    BundleActionBean mybundleAction = jpaService.execute(new BundleActionGetJPAExecutor(bundle.getId(), "coord1"));
    assertEquals(coord.getId(), mybundleAction.getCoordId());
}
